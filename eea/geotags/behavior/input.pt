<div tal:define="
  base_url view/base_url;
  dialog view/dialog;
  sidebar view/sidebar;
  basket view/basket;
  json view/json;
  country_mapping view/country_mapping;
  suggestions view/suggestions;
  multiline view/multiline;
  geojson view/geojson;
  id view/id;
  label view/label;
  fieldName view/name;
  ">

  <tal:google condition="python:'schemata_edit' not in context.REQUEST.URL">
    <script type="text/javascript" src="https://maps.google.com/maps/api/js?key={api_key}&amp;sensor=true&amp;language=en"></script>
  </tal:google>
  <div id="${id}" title="Edit ${label}"></div>
  <textarea name="${fieldName}" style="display: none" rows="10" title="${label}">${geojson}</textarea>
  <div id="${id}-geopreview"></div>
  <input type="button" name="edit" i18n:attributes="value" value="Edit" id="${id}-edit" class="standardButton input-block" />
  <script type="text/javascript">
    (function () {
      var id = '${id}';
      var name = '${fieldName}';
      var basket = '${basket}';
      var sidebar = '${sidebar}';
      var dialog = '${dialog}';
      var json = '${json}';
      var multiline = ${multiline};
      var suggestions = '${suggestions}';

      var settings = {
        template: dialog,
        sidebar: {
          json: json,
          template: sidebar,
          suggestions: suggestions,
          fieldName: id
        },
        map: {
          json: json,
          mapping_url: '${country_mapping}',
          fieldName: id
        },
        basket: {
          json: json,
          template: basket,
          fieldName: id,
          multiline: multiline,
          geojson: {
            type: 'FeatureCollection',
            features: []
          }
        }
      };

      var geojson = ${geojson};
      if (geojson.features) {
        settings.basket.geojson = geojson;
      }

      // Initialize popup
      jQuery(document).ready(function () {
        var geo = jQuery('#' + id).geodialog(settings);
        jQuery('#' + id + '-edit').click(function () {
          geo.dialog('open');
        });
      });

      // Display map
      jQuery(document).ready(function () {
        jQuery('#' + id + '-geopreview').geopreview({
          fieldName: id,
          json: geojson
        });
      });
    })();
  </script>
</div>